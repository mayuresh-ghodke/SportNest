<!DOCTYPE html>
<html lang="en" xmlns:th="https://www.thymeleaf.org/">

<head th:replace="~{fragments::head}">
    <style>
        input {
            width: 100%;
            padding: 10px;
            margin: 7px;
            margin-bottom: 16px;
            border: 1px solid #ccc;
            box-sizing: border-box;
            text-align: center;
        }

        .cart-item img {
            max-width: 100px;
            height: auto;
        }

        .quantity-input {
            width: 50px;
        }

        .cart-summary {
            background-color: #f8f9fa;
            border-radius: 10px;
        }
    </style>
    <script src="https://kit.fontawesome.com/b982f6e503.js" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body class="bg-white">
    <div th:replace="~{fragments::optional}"></div>
    <div th:replace="~{fragments::main-top}"></div>
    <header th:replace="~{fragments::main-header}"></header>

    <!-- Start Cart -->
    <div class="mt-3 container ">
        <h3 class="text-center font-weight-bold mb-3 ml-2" th:if="${grandTotal==0}">Oops! Your Cart is Empty.</h3>
        <p class="container text-center" th:if="${grandTotal==0}">
            <img src="images/empty_shopping_cart.jpeg" style="height: 450px;width: 600px;">
        </p>
        <h3 class="font-weight-bold my-4 text-center" th:if="${grandTotal!=0}">My Cart</h3>
        <div class="mt-5">
            <div class="row">
                <!-- Cart Items Section -->
                <div class="col-lg-8 col-md-8">
                    <div th:each="cartItem : ${shoppingCart.cartItems}" class="card mb-4">
                        <div class="card-body">
                            <div class="row cart-item align-items-center mb-3">
                                <div class="col-md-2">
                                    <img th:src="'data:image/jpeg;base64,' + ${cartItem.product.image}" alt="Product Image"
                                        class="img-fluid rounded" style="height: 100px; width: 100px;">
                                </div>

                                <div class="col-md-5">
                                    <h6 class="card-title" th:text="${cartItem.product.name}">Product Name</h6>
                                    <p id="unitprice" class="text-muted" th:text="'₹ ' + ${cartItem.unitPrice}">Price</p>
                                </div>

                                <div class="col-md-3 d-flex align-items-center">
                                    <button type="button" class="btn"
                                        th:onclick="|updateQuantity(this, 'decrement', '${cartItem.product.id}', '${cartItem.unitPrice}');|">
                                        <i class="fas fa-minus-square"></i>
                                    </button>

                                    <input type="number" name="quantity" th:value="${cartItem.quantity}"
                                        class="form-control text-center mx-2 quantity-input" readonly
                                        id="quantity-${cartItem.product.id}" style="width: 60px;">

                                    <button type="button" class="btn"
                                        th:onclick="|updateQuantity(this, 'increment', '${cartItem.product.id}', '${cartItem.unitPrice}');|">
                                        <i class="fas fa-plus-square"></i>
                                    </button>
                                </div>

                                <div class="col-md-2 text-right">
                                    <div id = "totalPriceByQtySection">
                                    <p class="font-weight-bold total-price" id="totalPrice-${cartItem.product.id}">
                                        ₹ <span th:text="${cartItem.unitPrice * cartItem.quantity}"></span>
                                    </p>
                                    </div>
                                    
                                    <button class="btn text-danger" onclick="removeCartItem(this, '${cartItem.product.id}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4 col-md-4">
                    <div class="card cart-summary" th:if="${grandTotal}">
                        <div class="card-body">
                            <h5 class="card-title mb-4">Order Summary</h5>
                            <div class="d-flex justify-content-between mb-3">
                                <span>Sub Total</span>
                                <span th:text="'₹ ' + ${grandTotal}"></span>
                            </div>
                            <div class="d-flex justify-content-between mb-3">
                                <span>Shipping</span>
                                <span>Free</span>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between mb-4">
                                <strong>Total</strong>
                                <strong id="grandTotal"  th:text="'₹ ' + ${grandTotal}"></strong>
                            </div>
                            <a th:href="@{/check-out}" class="btn btn-primary w-100">Proceed to Checkout</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer th:replace="~{fragments::footer}"></footer>

    <!-- JavaScript for Quantity and Total Updates -->
    <script>
        function updateQuantity(button, action, productId, unitPrice) {
            const quantityInput = $(button).siblings('.quantity-input');
            let currentQuantity = parseInt(quantityInput.val());
            const totalPriceElement = $(`#totalPrice-${productId}`);
    
            if (action === 'increment') {
                currentQuantity += 1;
            } else if (action === 'decrement' && currentQuantity > 1) {
                currentQuantity -= 1;
            } else {
                alert('Quantity must be at least 1');
                return;
            }
    
            quantityInput.val(currentQuantity);
            const newTotalPrice = unitPrice * currentQuantity;
            totalPriceElement.text('₹ ' + newTotalPrice);
    
            // Send AJAX request to update cart on server
            $.ajax({
                url: '/shop/update-cart',
                method: 'POST',
                data: {
                    id: productId,
                    quantity: currentQuantity,
                    action: 'update',
                },
                success: function (response) {
                    $('#grandTotal').text('₹ ' + response.newGrandTotal);
                    
                    var productId = $(this).data("id");  // Get product ID dynamically
                    
                    console.log(unitPrice, "Unit price");
                    console.log(currentQuantity, "Current Qty");
                    
                    $(`#totalPrice-${productId}`).text('₹ ' + response.totalPriceByQty);

            console.log("Updated Total Price:", response.totalPriceByQty);


                    $('#cartTotalItems').html(response.totalItems);
                },
                error: function (error) {
                    alert('Error updating cart!');
                    console.error('Error:', error);
                }
            });
        }
    </script>
</body>
</html>